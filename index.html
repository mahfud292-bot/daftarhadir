<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Digital SMA Negeri 1 Banggai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0) scale(1); }
            to { opacity: 0; transform: translateX(-150px) scale(0.7); }
        }
        @keyframes colorTransition {
            0% { background-color: rgb(59, 130, 246); }
            50% { background-color: rgb(249, 115, 22); }
            100% { background-color: rgb(239, 68, 68); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }
        
        .slide-in { animation: slideIn 0.6s ease-out; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .shake { animation: shake 0.8s ease-in-out; }
        .slide-out { animation: slideOut 0.6s ease-in-out forwards; }
        .color-transition { animation: colorTransition 0.8s ease-in-out; }
        .pulse { animation: pulse 2s infinite; }
        .bounce { animation: bounce 1s; }
        .glow { animation: glow 2s infinite; }
        
        .hover-scale:hover { 
            transform: scale(1.1); 
            transition: transform 0.3s ease; 
        }
        .hover-lift:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            transition: all 0.3s ease; 
        }
        .status-btn { 
            transition: all 0.3s ease; 
            position: relative;
            overflow: hidden;
        }
        .status-btn:hover { 
            transform: translateY(-2px) scale(1.05); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.2); 
        }
        .status-btn:active { 
            transform: scale(0.95); 
        }
        .student-row { 
            transition: all 0.4s ease; 
            position: relative;
        }
        .student-row:hover { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(147, 51, 234, 0.08));
            transform: translateX(5px);
        }
        .delete-preparing { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15)) !important; 
            border-left: 4px solid #ef4444;
        }
        .selected-for-delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border: 2px solid #ef4444;
            transform: scale(0.98);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .ripple:active:before {
            width: 300px;
            height: 300px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white p-8 shadow-2xl slide-in">
        <div class="container mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-3 glow">ABSENSI DIGITAL KELAS XI</h1>
            <h2 class="text-2xl md:text-3xl font-semibold mb-2">SMA NEGERI 1 BANGGAI</h2>
            <p class="text-xl mt-3 opacity-90">TAHUN PELAJARAN 2025/2026</p>
            <div class="mt-4 flex justify-center">
                <div class="bg-white bg-opacity-20 rounded-full px-6 py-2">
                    <span id="currentDateTime" class="text-lg font-medium"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="glass-effect shadow-lg p-4 fade-in sticky top-0 z-40">
        <div class="container mx-auto">
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="showTab('absensi')" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìã Absensi
                </button>
                <button onclick="showTab('statistik')" class="nav-btn bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìä Statistik
                </button>
                <button onclick="showTab('rekap')" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìà Rekap
                </button>
                <button onclick="showTab('penilaian')" class="nav-btn bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìù Penilaian
                </button>
                <button onclick="showTab('pengaturan')" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    ‚öôÔ∏è Pengaturan
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <!-- Tab Absensi -->
        <div id="absensi-tab" class="tab-content">
            <!-- Class Selection -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8 slide-in card-shadow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">Pilih Kelas:</label>
                        <select id="classSelect" onchange="changeClass()" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="XI-A">XI A</option>
                            <option value="XI-B">XI B</option>
                            <option value="XI-C">XI C</option>
                            <option value="XI-D">XI D</option>
                            <option value="XI-E">XI E</option>
                            <option value="XI-F">XI F</option>
                            <option value="XI-G">XI G</option>
                            <option value="XI-H">XI H</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">Wali Kelas:</label>
                        <input type="text" id="waliKelas" placeholder="Nama Wali Kelas" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">NIP Wali Kelas:</label>
                        <input type="text" id="nipWaliKelas" placeholder="NIP Wali Kelas" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 mb-6">
                    <button onclick="addStudent()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        ‚ûï Tambah Siswa
                    </button>
                    <button onclick="markAllPresent()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        ‚úÖ Hadir Semua
                    </button>
                    <button onclick="toggleBulkDelete()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üóëÔ∏è Hapus Massal
                    </button>
                    <button onclick="saveData()" class="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üíæ Simpan Data
                    </button>
                    <button onclick="exportToExcel()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üìä Export Excel
                    </button>
                </div>

                <!-- Bulk Delete Controls -->
                <div id="bulkDeleteControls" class="hidden mb-6 p-6 bg-gradient-to-r from-red-50 to-pink-50 rounded-2xl border-2 border-red-200">
                    <div class="flex flex-wrap gap-3 items-center">
                        <button onclick="selectAllStudents()" class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift">
                            ‚úì Pilih Semua
                        </button>
                        <button onclick="deselectAllStudents()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift">
                            ‚úó Batal Pilih
                        </button>
                        <button onclick="deleteSelectedStudents()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift pulse">
                            üóëÔ∏è Hapus Terpilih (<span id="selectedCount">0</span>)
                        </button>
                        <button onclick="toggleBulkDelete()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift">
                            ‚ùå Selesai
                        </button>
                    </div>
                </div>

                <!-- Undo Button -->
                <div id="undoContainer" class="hidden mb-6">
                    <button onclick="undoDelete()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white px-6 py-3 rounded-xl transition-all hover-lift bounce">
                        ‚Ü∂ Batalkan Penghapusan (<span id="undoCount">0</span> item)
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-green-400 to-green-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="hadirCount">0</div>
                        <div class="text-sm">Hadir</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="sakitCount">0</div>
                        <div class="text-sm">Sakit</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="izinCount">0</div>
                        <div class="text-sm">Izin</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-400 to-red-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="alphaCount">0</div>
                        <div class="text-sm">Alpha</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-400 to-purple-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="bolosCount">0</div>
                        <div class="text-sm">Bolos</div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-400 to-orange-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="terlambatCount">0</div>
                        <div class="text-sm">Terlambat</div>
                    </div>
                </div>
            </div>

            <!-- Student List -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 slide-in card-shadow">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    üë• Daftar Siswa 
                    <span class="ml-3 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-lg" id="totalStudents">0</span>
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <th class="p-4 text-left font-bold">No</th>
                                <th class="p-4 text-left font-bold">Nama Siswa</th>
                                <th class="p-4 text-left font-bold">NISN</th>
                                <th class="p-4 text-center font-bold">Status Kehadiran</th>
                                <th class="p-4 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentList">
                            <!-- Students will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Statistik -->
        <div id="statistik-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Monthly Statistics -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        üìà Statistik Bulanan
                        <select id="monthlyStudentSelect" onchange="updateMonthlyChart()" class="ml-4 p-2 border rounded-lg text-sm">
                            <option value="all">Semua Siswa</option>
                        </select>
                    </h3>
                    <canvas id="monthlyChart" width="400" height="300"></canvas>
                </div>
                
                <!-- Semester Statistics -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        üìä Statistik Semester
                        <select id="semesterStudentSelect" onchange="updateSemesterChart()" class="ml-4 p-2 border rounded-lg text-sm">
                            <option value="all">Semua Siswa</option>
                        </select>
                    </h3>
                    <canvas id="semesterChart" width="400" height="300"></canvas>
                </div>

                <!-- Attendance Trends -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow lg:col-span-2">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">üìâ Tren Kehadiran Kelas</h3>
                    <canvas id="trendChart" width="800" height="400"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab Rekap -->
        <div id="rekap-tab" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">üìã Rekap Kehadiran</h3>
                    <div class="flex gap-3">
                        <select id="rekapPeriod" onchange="updateRekap()" class="p-3 border-2 border-gray-300 rounded-xl">
                            <option value="bulanan">Bulanan</option>
                            <option value="semester">Semester</option>
                            <option value="tahunan">Tahunan</option>
                        </select>
                        <button onclick="printReport()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                            üñ®Ô∏è Cetak Rekap
                        </button>
                    </div>
                </div>
                <div id="rekapContent">
                    <!-- Rekap content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Tab Penilaian -->
        <div id="penilaian-tab" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">üìù Sistem Penilaian</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Input Nilai -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Input Nilai</h4>
                        <div class="space-y-4">
                            <select id="gradeStudentSelect" class="w-full p-3 border-2 border-gray-300 rounded-xl">
                                <option value="">Pilih Siswa</option>
                            </select>
                            <select id="gradeSubject" class="w-full p-3 border-2 border-gray-300 rounded-xl">
                                <option value="bahasa_inggris">Bahasa Inggris</option>
                            </select>
                            <input type="number" id="gradeValue" placeholder="Nilai (0-100)" min="0" max="100" class="w-full p-3 border-2 border-gray-300 rounded-xl">
                            <button onclick="addGrade()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-xl hover-lift">
                                ‚ûï Tambah Nilai
                            </button>
                        </div>
                    </div>
                    
                    <!-- Daftar Nilai -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Daftar Nilai</h4>
                        <div id="gradesList" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- Grades will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Pengaturan -->
        <div id="pengaturan-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Storage Settings -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">‚öôÔ∏è Pengaturan Sistem</h3>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">üíæ Penyimpanan Data</h4>
                        <div class="space-y-4">
                            <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-all">
                                <input type="radio" name="storage" value="local" checked class="mr-3 w-5 h-5">
                                <div>
                                    <span class="font-medium">Simpan di Browser (Local Storage)</span>
                                    <p class="text-sm text-gray-600">Data tersimpan permanen di browser</p>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-all">
                                <input type="radio" name="storage" value="session" class="mr-3 w-5 h-5">
                                <div>
                                    <span class="font-medium">Simpan Sementara (Session Storage)</span>
                                    <p class="text-sm text-gray-600">Data hilang saat browser ditutup</p>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-all">
                                <input type="radio" name="storage" value="memory" class="mr-3 w-5 h-5">
                                <div>
                                    <span class="font-medium">Simpan di Memori (Tidak Permanen)</span>
                                    <p class="text-sm text-gray-600">Data hilang saat halaman di-refresh</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">üóÇÔ∏è Manajemen Data</h4>
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="exportData()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-3 rounded-xl transition-all hover-lift">
                                üì§ Export Data JSON
                            </button>
                            <button onclick="importData()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl transition-all hover-lift">
                                üì• Import Data JSON
                            </button>
                            <button onclick="backupData()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-3 rounded-xl transition-all hover-lift">
                                üíæ Backup Otomatis
                            </button>
                            <button onclick="clearAllData()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-3 rounded-xl transition-all hover-lift">
                                üóëÔ∏è Hapus Semua Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Info -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä Informasi Sistem</h3>
                    
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200">
                            <h4 class="text-lg font-semibold mb-3 text-blue-800">Status Penyimpanan</h4>
                            <p class="text-blue-700">Mode: <span id="storageStatus" class="font-bold">Local Storage</span></p>
                            <p class="text-blue-700">Status: <span class="font-bold text-green-600">Aktif</span></p>
                        </div>

                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200">
                            <h4 class="text-lg font-semibold mb-3 text-green-800">Data Tersimpan</h4>
                            <p class="text-green-700">Total Siswa: <span id="totalDataCount" class="font-bold">0</span></p>
                            <p class="text-green-700">Total Kelas: <span class="font-bold">8</span></p>
                            <p class="text-green-700">Terakhir Disimpan: <span id="lastSaved" class="font-bold">-</span></p>
                        </div>

                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border border-purple-200">
                            <h4 class="text-lg font-semibold mb-3 text-purple-800">Statistik Penggunaan</h4>
                            <p class="text-purple-700">Sesi Aktif: <span id="sessionTime" class="font-bold">0 menit</span></p>
                            <p class="text-purple-700">Auto-save: <span class="font-bold text-green-600">Aktif (30s)</span></p>
                        </div>

                        <!-- System Health -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
                            <h4 class="text-lg font-semibold mb-3 text-yellow-800">Kesehatan Sistem</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Storage Space:</span>
                                    <span class="font-bold text-green-600">Normal</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Data Integrity:</span>
                                    <span class="font-bold text-green-600">OK</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Performance:</span>
                                    <span class="font-bold text-green-600">Optimal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Konfirmasi -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 slide-in card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold mb-4 text-gray-800">Konfirmasi Tindakan</h3>
                <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            </div>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all hover-lift">
                    ‚ùå Batal
                </button>
                <button id="confirmButton" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl transition-all hover-lift">
                    ‚úÖ Konfirmasi
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-lg font-semibold">Memproses...</p>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg hidden z-50">
        <div class="flex items-center">
            <span class="text-xl mr-2">‚úÖ</span>
            <span id="successMessage">Berhasil!</span>
        </div>
    </div>

    <script>
        // Global Variables
        let currentClass = 'XI-A';
        let students = {};
        let grades = {};
        let deletedStudents = [];
        let bulkDeleteMode = false;
        let selectedStudents = new Set();
        let storageType = 'local';
        let sessionStartTime = Date.now();
        let autoSaveInterval;

        // Initialize data structure for all classes
        const classes = ['XI-A', 'XI-B', 'XI-C', 'XI-D', 'XI-E', 'XI-F', 'XI-G', 'XI-H'];
        const subjects = ['matematika', 'fisika', 'kimia', 'biologi', 'bahasa_indonesia', 'bahasa_inggris'];
        
        // Initialize students and grades for all classes
        classes.forEach(cls => {
            if (!students[cls]) {
                students[cls] = [];
                grades[cls] = {};
                // Add sample students for each class
                for (let i = 1; i <= 39; i++) {
                    const studentId = Date.now() + i + Math.random();
                    students[cls].push({
                        id: studentId,
                        name: `Siswa ${i}`,
                        nisn: `2025${String(i).padStart(3, '0')}${Math.floor(Math.random() * 1000)}`,
                        status: 'H',
                        attendance: generateSampleAttendance()
                    });
                    
                    // Initialize grades for each student
                    grades[cls][studentId] = {};
                    subjects.forEach(subject => {
                        grades[cls][studentId][subject] = [];
                    });
                }
            }
        });

        // Generate sample attendance data
        function generateSampleAttendance() {
            const attendance = {};
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            months.forEach(month => {
                attendance[month] = {
                    H: Math.floor(Math.random() * 20) + 15,
                    S: Math.floor(Math.random() * 3) + 1,
                    I: Math.floor(Math.random() * 3) + 1,
                    A: Math.floor(Math.random() * 2),
                    B: Math.floor(Math.random() * 2),
                    T: Math.floor(Math.random() * 3) + 1
                };
            });
            return attendance;
        }

        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-300');
            });
            
            event.target.classList.add('ring-4', 'ring-blue-300');
            
            if (tabName === 'statistik') {
                updateCharts();
                populateStudentSelects();
            } else if (tabName === 'rekap') {
                updateRekap();
            } else if (tabName === 'penilaian') {
                populateGradeStudentSelect();
                updateGradesList();
            } else if (tabName === 'pengaturan') {
                updateSystemInfo();
            }
        }

        // Class Management
        function changeClass() {
            currentClass = document.getElementById('classSelect').value;
            renderStudentList();
            loadClassData();
            updateQuickStats();
        }

        function loadClassData() {
            const classData = getStoredData(`class_${currentClass}`) || {};
            document.getElementById('waliKelas').value = classData.waliKelas || '';
            document.getElementById('nipWaliKelas').value = classData.nipWaliKelas || '';
        }

        // Student Management
        function addStudent() {
            showLoading();
            
            setTimeout(() => {
                const newStudent = {
                    id: Date.now() + Math.random(),
                    name: 'Siswa Baru',
                    nisn: '',
                    status: 'H',
                    attendance: generateSampleAttendance()
                };
                
                students[currentClass].push(newStudent);
                
                // Initialize grades for new student
                grades[currentClass][newStudent.id] = {};
                subjects.forEach(subject => {
                    grades[currentClass][newStudent.id][subject] = [];
                });
                
                renderStudentList();
                updateQuickStats();
                saveData();
                hideLoading();
                showSuccess('Siswa baru berhasil ditambahkan!');
                
                // Animate new student
                setTimeout(() => {
                    const newRow = document.querySelector(`[data-student-id="${newStudent.id}"]`);
                    if (newRow) {
                        newRow.classList.add('slide-in', 'glow');
                    }
                }, 100);
            }, 500);
        }

        function deleteStudent(studentId) {
            const student = students[currentClass].find(s => s.id === studentId);
            if (!student) return;

            showConfirmModal(
                `Apakah Anda yakin ingin menghapus siswa "${student.name}"? Data nilai dan kehadiran akan ikut terhapus.`,
                () => {
                    const studentRow = document.querySelector(`[data-student-id="${studentId}"]`);
                    
                    // Add shake animation
                    studentRow.classList.add('shake', 'delete-preparing');
                    
                    setTimeout(() => {
                        // Add color transition and slide out
                        studentRow.classList.add('color-transition', 'slide-out');
                        
                        setTimeout(() => {
                            // Store for undo
                            const studentIndex = students[currentClass].findIndex(s => s.id === studentId);
                            const deletedStudent = students[currentClass].splice(studentIndex, 1)[0];
                            const deletedGrades = grades[currentClass][studentId];
                            delete grades[currentClass][studentId];
                            
                            deletedStudents.push({
                                student: deletedStudent,
                                grades: deletedGrades,
                                class: currentClass,
                                index: studentIndex
                            });
                            
                            renderStudentList();
                            updateQuickStats();
                            saveData();
                            showUndoButton();
                            showSuccess('Siswa berhasil dihapus!');
                        }, 600);
                    }, 800);
                }
            );
        }

        function toggleBulkDelete() {
            bulkDeleteMode = !bulkDeleteMode;
            const controls = document.getElementById('bulkDeleteControls');
            
            if (bulkDeleteMode) {
                controls.classList.remove('hidden');
                controls.classList.add('fade-in');
            } else {
                controls.classList.add('hidden');
                selectedStudents.clear();
            }
            
            renderStudentList();
            updateSelectedCount();
        }

        function selectAllStudents() {
            students[currentClass].forEach(student => {
                selectedStudents.add(student.id);
            });
            renderStudentList();
            updateSelectedCount();
        }

        function deselectAllStudents() {
            selectedStudents.clear();
            renderStudentList();
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = selectedStudents.size;
            }
        }

        function deleteSelectedStudents() {
            if (selectedStudents.size === 0) {
                showError('Pilih siswa yang akan dihapus terlebih dahulu!');
                return;
            }

            showConfirmModal(
                `Apakah Anda yakin ingin menghapus ${selectedStudents.size} siswa yang dipilih? Data nilai dan kehadiran akan ikut terhapus.`,
                () => {
                    showLoading();
                    const studentsToDelete = Array.from(selectedStudents);
                    
                    studentsToDelete.forEach((studentId, index) => {
                        const studentRow = document.querySelector(`[data-student-id="${studentId}"]`);
                        if (studentRow) {
                            setTimeout(() => {
                                studentRow.classList.add('shake', 'delete-preparing');
                                
                                setTimeout(() => {
                                    studentRow.classList.add('slide-out');
                                }, 500);
                            }, index * 100);
                        }
                    });

                    setTimeout(() => {
                        studentsToDelete.forEach(studentId => {
                            const studentIndex = students[currentClass].findIndex(s => s.id === studentId);
                            if (studentIndex !== -1) {
                                const deletedStudent = students[currentClass].splice(studentIndex, 1)[0];
                                const deletedGrades = grades[currentClass][studentId];
                                delete grades[currentClass][studentId];
                                
                                deletedStudents.push({
                                    student: deletedStudent,
                                    grades: deletedGrades,
                                    class: currentClass,
                                    index: studentIndex
                                });
                            }
                        });
                        
                        selectedStudents.clear();
                        renderStudentList();
                        updateQuickStats();
                        saveData();
                        showUndoButton();
                        hideLoading();
                        showSuccess(`${studentsToDelete.length} siswa berhasil dihapus!`);
                    }, 1500);
                }
            );
        }

        function undoDelete() {
            if (deletedStudents.length === 0) return;

            showLoading();
            
            setTimeout(() => {
                const restored = deletedStudents.pop();
                students[restored.class].splice(restored.index, 0, restored.student);
                grades[restored.class][restored.student.id] = restored.grades;
                
                if (restored.class === currentClass) {
                    renderStudentList();
                    updateQuickStats();
                }
                
                saveData();
                updateUndoCount();
                
                if (deletedStudents.length === 0) {
                    hideUndoButton();
                }
                
                hideLoading();
                showSuccess('Penghapusan berhasil dibatalkan!');
            }, 500);
        }

        function showUndoButton() {
            const undoContainer = document.getElementById('undoContainer');
            undoContainer.classList.remove('hidden');
            undoContainer.classList.add('fade-in');
            updateUndoCount();
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                if (deletedStudents.length > 0) {
                    hideUndoButton();
                }
            }, 15000);
        }

        function hideUndoButton() {
            const undoContainer = document.getElementById('undoContainer');
            undoContainer.classList.add('hidden');
        }

        function updateUndoCount() {
            const countElement = document.getElementById('undoCount');
            if (countElement) {
                countElement.textContent = deletedStudents.length;
            }
        }

        function updateStudentName(studentId, newName) {
            const student = students[currentClass].find(s => s.id === studentId);
            if (student) {
                student.name = newName;
                saveData();
            }
        }

        function updateStudentNISN(studentId, newNISN) {
            const student = students[currentClass].find(s => s.id === studentId);
            if (student) {
                student.nisn = newNISN;
                saveData();
            }
        }

        function updateAttendanceStatus(studentId, status) {
            const student = students[currentClass].find(s => s.id === studentId);
            if (student) {
                student.status = status;
                updateQuickStats();
                saveData();
                
                // Add animation to status change
                const statusButtons = document.querySelectorAll(`[data-student-id="${studentId}"] .status-btn`);
                statusButtons.forEach(btn => {
                    btn.classList.add('pulse');
                    setTimeout(() => btn.classList.remove('pulse'), 1000);
                });
            }
        }

        function markAllPresent() {
            showLoading();
            
            setTimeout(() => {
                students[currentClass].forEach(student => {
                    student.status = 'H';
                });
                renderStudentList();
                updateQuickStats();
                saveData();
                hideLoading();
                showSuccess('Semua siswa berhasil ditandai hadir!');
                
                // Show success animation
                const studentRows = document.querySelectorAll('.student-row');
                studentRows.forEach((row, index) => {
                    setTimeout(() => {
                        row.classList.add('fade-in', 'glow');
                        setTimeout(() => row.classList.remove('glow'), 2000);
                    }, index * 50);
                });
            }, 1000);
        }

        function toggleStudentSelection(studentId) {
            if (selectedStudents.has(studentId)) {
                selectedStudents.delete(studentId);
            } else {
                selectedStudents.add(studentId);
            }
            renderStudentList();
            updateSelectedCount();
        }

        // Quick Stats
        function updateQuickStats() {
            const stats = {
                H: 0, S: 0, I: 0, A: 0, B: 0, T: 0
            };
            
            students[currentClass].forEach(student => {
                stats[student.status]++;
            });
            
            document.getElementById('hadirCount').textContent = stats.H;
            document.getElementById('sakitCount').textContent = stats.S;
            document.getElementById('izinCount').textContent = stats.I;
            document.getElementById('alphaCount').textContent = stats.A;
            document.getElementById('bolosCount').textContent = stats.B;
            document.getElementById('terlambatCount').textContent = stats.T;
            document.getElementById('totalStudents').textContent = students[currentClass].length;
        }

        // Render Functions
        function renderStudentList() {
            const tbody = document.getElementById('studentList');
            tbody.innerHTML = '';

            students[currentClass].forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'student-row border-b-2 border-gray-100 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50';
                row.setAttribute('data-student-id', student.id);
                
                if (selectedStudents.has(student.id)) {
                    row.classList.add('selected-for-delete');
                }

                row.innerHTML = `
                    <td class="p-4 font-semibold text-gray-700">${index + 1}</td>
                    <td class="p-4">
                        <input type="text" value="${student.name}" 
                               onchange="updateStudentName(${student.id}, this.value)"
                               class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </td>
                    <td class="p-4">
                        <input type="text" value="${student.nisn}" 
                               onchange="updateStudentNISN(${student.id}, this.value)"
                               class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex flex-wrap justify-center gap-2">
                            ${['H', 'S', 'I', 'A', 'B', 'T'].map(status => `
                                <button onclick="updateAttendanceStatus(${student.id}, '${status}')"
                                        class="status-btn px-3 py-2 rounded-lg text-sm font-bold transition-all hover-lift ripple
                                               ${student.status === status ? getStatusColor(status) : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    ${getStatusLabel(status)}
                                </button>
                            `).join('')}
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center items-center gap-2">
                            ${bulkDeleteMode ? `
                                <input type="checkbox" 
                                       ${selectedStudents.has(student.id) ? 'checked' : ''}
                                       onchange="toggleStudentSelection(${student.id})"
                                       class="w-6 h-6 text-red-600 rounded focus:ring-red-500">
                            ` : ''}
                            <button onclick="deleteStudent(${student.id})" 
                                    class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-3 py-2 rounded-lg text-sm transition-all hover-lift ripple">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            const colors = {
                'H': 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg',
                'S': 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white shadow-lg',
                'I': 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg',
                'A': 'bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg',
                'B': 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg',
                'T': 'bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg'
            };
            return colors[status] || 'bg-gray-500 text-white';
        }

        function getStatusLabel(status) {
            const labels = {
                'H': 'Hadir',
                'S': 'Sakit',
                'I': 'Izin',
                'A': 'Alpha',
                'B': 'Bolos',
                'T': 'Terlambat'
            };
            return labels[status] || status;
        }

        // Charts
        function populateStudentSelects() {
            const monthlySelect = document.getElementById('monthlyStudentSelect');
            const semesterSelect = document.getElementById('semesterStudentSelect');
            
            // Clear existing options except "Semua Siswa"
            monthlySelect.innerHTML = '<option value="all">Semua Siswa</option>';
            semesterSelect.innerHTML = '<option value="all">Semua Siswa</option>';
            
            students[currentClass].forEach(student => {
                const option1 = new Option(student.name, student.id);
                const option2 = new Option(student.name, student.id);
                monthlySelect.add(option1);
                semesterSelect.add(option2);
            });
        }

        function updateCharts() {
            updateMonthlyChart();
            updateSemesterChart();
            updateTrendChart();
        }

        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const selectedStudent = document.getElementById('monthlyStudentSelect').value;
            
            let monthlyData;
            if (selectedStudent === 'all') {
                // Calculate average attendance per month for all students
                monthlyData = months.map(month => {
                    const total = students[currentClass].reduce((sum, student) => {
                        return sum + (student.attendance[month]?.H || 0);
                    }, 0);
                    return students[currentClass].length > 0 ? Math.round(total / students[currentClass].length) : 0;
                });
            } else {
                // Show data for specific student
                const student = students[currentClass].find(s => s.id == selectedStudent);
                monthlyData = months.map(month => student?.attendance[month]?.H || 0);
            }

            // Clear previous chart
            Chart.getChart(ctx)?.destroy();

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: selectedStudent === 'all' ? 'Rata-rata Kehadiran' : 'Kehadiran Siswa',
                        data: monthlyData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Statistik Bulanan Kelas ${currentClass}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 31,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateSemesterChart() {
            const ctx = document.getElementById('semesterChart').getContext('2d');
            const semesters = ['Semester 1', 'Semester 2'];
            const selectedStudent = document.getElementById('semesterStudentSelect').value;
            
            let semesterData;
            if (selectedStudent === 'all') {
                // Calculate semester data for all students
                semesterData = semesters.map((semester, index) => {
                    const semesterMonths = index === 0 ? 
                        ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] : 
                        ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    
                    const total = students[currentClass].reduce((sum, student) => {
                        const semesterTotal = semesterMonths.reduce((monthSum, month) => {
                            return monthSum + (student.attendance[month]?.H || 0);
                        }, 0);
                        return sum + semesterTotal;
                    }, 0);
                    
                    return students[currentClass].length > 0 ? Math.round(total / students[currentClass].length) : 0;
                });
            } else {
                // Show data for specific student
                const student = students[currentClass].find(s => s.id == selectedStudent);
                semesterData = semesters.map((semester, index) => {
                    const semesterMonths = index === 0 ? 
                        ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] : 
                        ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    
                    return semesterMonths.reduce((sum, month) => {
                        return sum + (student?.attendance[month]?.H || 0);
                    }, 0);
                });
            }

            // Clear previous chart
            Chart.getChart(ctx)?.destroy();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: semesters,
                    datasets: [{
                        label: selectedStudent === 'all' ? 'Rata-rata Kehadiran' : 'Total Kehadiran',
                        data: semesterData,
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)', 
                            'rgba(168, 85, 247, 0.8)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)', 
                            'rgb(168, 85, 247)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Statistik Semester Kelas ${currentClass}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Calculate trends for all status types
            const datasets = [
                {
                    label: 'Hadir',
                    data: months.map(month => {
                        const total = students[currentClass].reduce((sum, student) => {
                            return sum + (student.attendance[month]?.H || 0);
                        }, 0);
                        return students[currentClass].length > 0 ? Math.round(total / students[currentClass].length) : 0;
                    }),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Sakit',
                    data: months.map(month => {
                        const total = students[currentClass].reduce((sum, student) => {
                            return sum + (student.attendance[month]?.S || 0);
                        }, 0);
                        return students[currentClass].length > 0 ? Math.round(total / students[currentClass].length) : 0;
                    }),
                    borderColor: 'rgb(234, 179, 8)',
                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Alpha',
                    data: months.map(month => {
                        const total = students[currentClass].reduce((sum, student) => {
                            return sum + (student.attendance[month]?.A || 0);
                        }, 0);
                        return students[currentClass].length > 0 ? Math.round(total / students[currentClass].length) : 0;
                    }),
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Bolos',
                    data: months.map(month => {
                        const total = students[currentClass].reduce((sum, student) => {
                            return sum + (student.attendance[month]?.B || 0);
                        }, 0);
                        return students[currentClass].length > 0 ? Math.round(total / students[currentClass].length) : 0;
                    }),
                    borderColor: 'rgb(147, 51, 234)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.4
                }
            ];

            // Clear previous chart
            Chart.getChart(ctx)?.destroy();

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Tren Kehadiran Kelas ${currentClass}`,
                            font: { size: 18, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Rekap
        function updateRekap() {
            const rekapContent = document.getElementById('rekapContent');
            const period = document.getElementById('rekapPeriod').value;
            
            let html = `
                <div class="mb-8">
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Rekap Kehadiran ${period.charAt(0).toUpperCase() + period.slice(1)} - Kelas ${currentClass}</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full border-2 border-gray-300 rounded-xl overflow-hidden">
                            <thead>
                                <tr class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                                    <th class="border border-gray-300 p-4 font-bold">No</th>
                                    <th class="border border-gray-300 p-4 font-bold">Nama Siswa</th>
                                    <th class="border border-gray-300 p-4 font-bold">NISN</th>
                                    <th class="border border-gray-300 p-4 font-bold">Hadir</th>
                                    <th class="border border-gray-300 p-4 font-bold">Sakit</th>
                                    <th class="border border-gray-300 p-4 font-bold">Izin</th>
                                    <th class="border border-gray-300 p-4 font-bold">Alpha</th>
                                    <th class="border border-gray-300 p-4 font-bold">Bolos</th>
                                    <th class="border border-gray-300 p-4 font-bold">Terlambat</th>
                                    <th class="border border-gray-300 p-4 font-bold">Persentase</th>
                                    <th class="border border-gray-300 p-4 font-bold">Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            students[currentClass].forEach((student, index) => {
                const stats = calculateStudentStats(student, period);
                const statusClass = stats.percentage >= 80 ? 'text-green-600 font-bold' : 
                                  stats.percentage >= 70 ? 'text-yellow-600 font-bold' : 'text-red-600 font-bold';
                const statusText = stats.percentage >= 80 ? '‚úÖ Baik' : 
                                 stats.percentage >= 70 ? '‚ö†Ô∏è Cukup' : '‚ùå Kurang';
                
                html += `
                    <tr class="hover:bg-gray-50 transition-all">
                        <td class="border border-gray-300 p-4 text-center font-semibold">${index + 1}</td>
                        <td class="border border-gray-300 p-4 font-medium">${student.name}</td>
                        <td class="border border-gray-300 p-4">${student.nisn}</td>
                        <td class="border border-gray-300 p-4 text-center bg-green-50 font-semibold">${stats.H}</td>
                        <td class="border border-gray-300 p-4 text-center bg-yellow-50 font-semibold">${stats.S}</td>
                        <td class="border border-gray-300 p-4 text-center bg-blue-50 font-semibold">${stats.I}</td>
                        <td class="border border-gray-300 p-4 text-center bg-red-50 font-semibold">${stats.A}</td>
                        <td class="border border-gray-300 p-4 text-center bg-purple-50 font-semibold">${stats.B}</td>
                        <td class="border border-gray-300 p-4 text-center bg-orange-50 font-semibold">${stats.T}</td>
                        <td class="border border-gray-300 p-4 text-center font-bold text-lg">${stats.percentage}%</td>
                        <td class="border border-gray-300 p-4 text-center ${statusClass}">${statusText}</td>
                    </tr>
                `;
            });

            // Add summary row
            const totalStats = calculateClassStats(period);
            html += `
                <tr class="bg-gradient-to-r from-gray-100 to-gray-200 font-bold">
                    <td colspan="3" class="border border-gray-300 p-4 text-center">RATA-RATA KELAS</td>
                    <td class="border border-gray-300 p-4 text-center bg-green-100">${totalStats.H}</td>
                    <td class="border border-gray-300 p-4 text-center bg-yellow-100">${totalStats.S}</td>
                    <td class="border border-gray-300 p-4 text-center bg-blue-100">${totalStats.I}</td>
                    <td class="border border-gray-300 p-4 text-center bg-red-100">${totalStats.A}</td>
                    <td class="border border-gray-300 p-4 text-center bg-purple-100">${totalStats.B}</td>
                    <td class="border border-gray-300 p-4 text-center bg-orange-100">${totalStats.T}</td>
                    <td class="border border-gray-300 p-4 text-center text-xl">${totalStats.percentage}%</td>
                    <td class="border border-gray-300 p-4 text-center">${totalStats.status}</td>
                </tr>
            `;

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            rekapContent.innerHTML = html;
        }

        function calculateStudentStats(student, period) {
            let months;
            switch(period) {
                case 'bulanan':
                    months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    break;
                case 'semester':
                    months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; // Semester 1
                    break;
                case 'tahunan':
                    months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    break;
                default:
                    months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            }

            const stats = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
            
            months.forEach(month => {
                if (student.attendance[month]) {
                    stats.H += student.attendance[month].H || 0;
                    stats.S += student.attendance[month].S || 0;
                    stats.I += student.attendance[month].I || 0;
                    stats.A += student.attendance[month].A || 0;
                    stats.B += student.attendance[month].B || 0;
                    stats.T += student.attendance[month].T || 0;
                }
            });

            const total = stats.H + stats.S + stats.I + stats.A + stats.B + stats.T;
            const percentage = total > 0 ? Math.round((stats.H / total) * 100) : 0;

            return { ...stats, percentage };
        }

        function calculateClassStats(period) {
            const allStats = students[currentClass].map(student => calculateStudentStats(student, period));
            const totalStudents = allStats.length;
            
            if (totalStudents === 0) return { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0, percentage: 0, status: '-' };

            const avgStats = {
                H: Math.round(allStats.reduce((sum, stat) => sum + stat.H, 0) / totalStudents),
                S: Math.round(allStats.reduce((sum, stat) => sum + stat.S, 0) / totalStudents),
                I: Math.round(allStats.reduce((sum, stat) => sum + stat.I, 0) / totalStudents),
                A: Math.round(allStats.reduce((sum, stat) => sum + stat.A, 0) / totalStudents),
                B: Math.round(allStats.reduce((sum, stat) => sum + stat.B, 0) / totalStudents),
                T: Math.round(allStats.reduce((sum, stat) => sum + stat.T, 0) / totalStudents)
            };

            const avgPercentage = Math.round(allStats.reduce((sum, stat) => sum + stat.percentage, 0) / totalStudents);
            const status = avgPercentage >= 80 ? '‚úÖ Baik' : avgPercentage >= 70 ? '‚ö†Ô∏è Cukup' : '‚ùå Kurang';

            return { ...avgStats, percentage: avgPercentage, status };
        }

        function printReport() {
            window.print();
        }

        // Grading System
        function populateGradeStudentSelect() {
            const select = document.getElementById('gradeStudentSelect');
            select.innerHTML = '<option value="">Pilih Siswa</option>';
            
            students[currentClass].forEach(student => {
                const option = new Option(student.name, student.id);
                select.add(option);
            });
        }

        function addGrade() {
            const studentId = document.getElementById('gradeStudentSelect').value;
            const subject = document.getElementById('gradeSubject').value;
            const gradeValue = parseFloat(document.getElementById('gradeValue').value);
            
            if (!studentId || !subject || isNaN(gradeValue) || gradeValue < 0 || gradeValue > 100) {
                showError('Mohon lengkapi semua field dengan benar!');
                return;
            }

            if (!grades[currentClass][studentId]) {
                grades[currentClass][studentId] = {};
            }
            if (!grades[currentClass][studentId][subject]) {
                grades[currentClass][studentId][subject] = [];
            }

            grades[currentClass][studentId][subject].push({
                value: gradeValue,
                date: new Date().toLocaleDateString('id-ID'),
                timestamp: Date.now()
            });

            // Clear form
            document.getElementById('gradeValue').value = '';
            
            updateGradesList();
            saveData();
            showSuccess('Nilai berhasil ditambahkan!');
        }

        function updateGradesList() {
            const gradesList = document.getElementById('gradesList');
            gradesList.innerHTML = '';

            students[currentClass].forEach(student => {
                if (grades[currentClass][student.id]) {
                    subjects.forEach(subject => {
                        const studentGrades = grades[currentClass][student.id][subject] || [];
                        if (studentGrades.length > 0) {
                            const gradeItem = document.createElement('div');
                            gradeItem.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200';
                            
                            const average = studentGrades.reduce((sum, grade) => sum + grade.value, 0) / studentGrades.length;
                            const gradeColor = average >= 80 ? 'text-green-600' : average >= 70 ? 'text-yellow-600' : 'text-red-600';
                            
                            gradeItem.innerHTML = `
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="font-semibold">${student.name} - ${subject.replace('_', ' ').toUpperCase()}</h5>
                                    <span class="font-bold ${gradeColor}">Rata-rata: ${average.toFixed(1)}</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${studentGrades.map((grade, index) => `
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
                                            ${grade.value} (${grade.date})
                                            <button onclick="deleteGrade('${student.id}', '${subject}', ${index})" 
                                                    class="ml-1 text-red-500 hover:text-red-700">√ó</button>
                                        </span>
                                    `).join('')}
                                </div>
                            `;
                            
                            gradesList.appendChild(gradeItem);
                        }
                    });
                }
            });
        }

        function deleteGrade(studentId, subject, gradeIndex) {
            showConfirmModal(
                'Apakah Anda yakin ingin menghapus nilai ini?',
                () => {
                    grades[currentClass][studentId][subject].splice(gradeIndex, 1);
                    updateGradesList();
                    saveData();
                    showSuccess('Nilai berhasil dihapus!');
                }
            );
        }

        // Export Functions
        function exportToExcel() {
            showLoading();
            
            setTimeout(() => {
                const data = students[currentClass].map((student, index) => {
                    const stats = calculateStudentStats(student, 'tahunan');
                    return {
                        'No': index + 1,
                        'Nama': student.name,
                        'NISN': student.nisn,
                        'Hadir': stats.H,
                        'Sakit': stats.S,
                        'Izin': stats.I,
                        'Alpha': stats.A,
                        'Bolos': stats.B,
                        'Terlambat': stats.T,
                        'Persentase': stats.percentage + '%'
                    };
                });

                const csv = convertToCSV(data);
                downloadCSV(csv, `absensi_${currentClass}_${new Date().toISOString().split('T')[0]}.csv`);
                
                hideLoading();
                showSuccess('Data berhasil diekspor!');
            }, 1000);
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Storage Management
        function saveData() {
            const data = {
                students: students,
                grades: grades,
                classes: {},
                timestamp: new Date().toISOString()
            };

            // Save class-specific data
            classes.forEach(cls => {
                const waliKelas = cls === currentClass ? document.getElementById('waliKelas').value : '';
                const nipWaliKelas = cls === currentClass ? document.getElementById('nipWaliKelas').value : '';
                
                data.classes[cls] = {
                    waliKelas: waliKelas || (getStoredData(`class_${cls}`)?.waliKelas || ''),
                    nipWaliKelas: nipWaliKelas || (getStoredData(`class_${cls}`)?.nipWaliKelas || '')
                };
            });

            storeData('absensi_data', data);
            updateSystemInfo();
            
            // Update last saved time
            document.getElementById('lastSaved').textContent = new Date().toLocaleTimeString('id-ID');
        }

        function loadData() {
            const data = getStoredData('absensi_data');
            if (data) {
                students = data.students || students;
                grades = data.grades || grades;
                
                // Load class data
                if (data.classes && data.classes[currentClass]) {
                    const classData = data.classes[currentClass];
                    document.getElementById('waliKelas').value = classData.waliKelas || '';
                    document.getElementById('nipWaliKelas').value = classData.nipWaliKelas || '';
                }
            }
            renderStudentList();
            updateQuickStats();
        }

        function storeData(key, data) {
            const dataString = JSON.stringify(data);
            
            try {
                switch(storageType) {
                    case 'local':
                        localStorage.setItem(key, dataString);
                        break;
                    case 'session':
                        sessionStorage.setItem(key, dataString);
                        break;
                    case 'memory':
                        window.memoryStorage = window.memoryStorage || {};
                        window.memoryStorage[key] = dataString;
                        break;
                }
            } catch (error) {
                showError('Error menyimpan data: ' + error.message);
            }
        }

        function getStoredData(key) {
            let dataString;
            
            try {
                switch(storageType) {
                    case 'local':
                        dataString = localStorage.getItem(key);
                        break;
                    case 'session':
                        dataString = sessionStorage.getItem(key);
                        break;
                    case 'memory':
                        window.memoryStorage = window.memoryStorage || {};
                        dataString = window.memoryStorage[key];
                        break;
                }
                
                return dataString ? JSON.parse(dataString) : null;
            } catch (error) {
                showError('Error membaca data: ' + error.message);
                return null;
            }
        }

        function exportData() {
            const data = {
                students: students,
                grades: grades,
                timestamp: new Date().toISOString(),
                version: '2.0',
                school: 'SMA Negeri 1 Banggai',
                year: '2025/2026'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `absensi_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showSuccess('Data berhasil diekspor!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                showLoading();
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.students && data.grades) {
                            students = data.students;
                            grades = data.grades;
                            renderStudentList();
                            updateQuickStats();
                            saveData();
                            hideLoading();
                            showSuccess('Data berhasil diimport!');
                        } else {
                            hideLoading();
                            showError('Format file tidak valid!');
                        }
                    } catch (error) {
                        hideLoading();
                        showError('Error membaca file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function backupData() {
            showLoading();
            
            setTimeout(() => {
                // Simulate backup process
                const backupData = {
                    ...getStoredData('absensi_data'),
                    backupTime: new Date().toISOString(),
                    backupType: 'automatic'
                };
                
                storeData('absensi_backup', backupData);
                hideLoading();
                showSuccess('Backup otomatis berhasil dibuat!');
            }, 2000);
        }

        function clearAllData() {
            showConfirmModal(
                'Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan dan akan menghapus semua data siswa, nilai, dan pengaturan!',
                () => {
                    showLoading();
                    
                    setTimeout(() => {
                        // Reset all data
                        classes.forEach(cls => {
                            students[cls] = [];
                            grades[cls] = {};
                        });
                        
                        deletedStudents = [];
                        selectedStudents.clear();
                        
                        // Clear storage
                        switch(storageType) {
                            case 'local':
                                localStorage.clear();
                                break;
                            case 'session':
                                sessionStorage.clear();
                                break;
                            case 'memory':
                                window.memoryStorage = {};
                                break;
                        }
                        
                        // Reset form
                        document.getElementById('waliKelas').value = '';
                        document.getElementById('nipWaliKelas').value = '';
                        
                        renderStudentList();
                        updateQuickStats();
                        updateSystemInfo();
                        hideLoading();
                        showSuccess('Semua data telah dihapus!');
                    }, 1500);
                }
            );
        }

        function updateSystemInfo() {
            const statusElement = document.getElementById('storageStatus');
            const countElement = document.getElementById('totalDataCount');
            
            // Update storage status
            const storageRadios = document.querySelectorAll('input[name="storage"]');
            storageRadios.forEach(radio => {
                if (radio.checked) {
                    storageType = radio.value;
                }
                
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        storageType = this.value;
                        saveData();
                        updateSystemInfo();
                        showSuccess('Pengaturan penyimpanan berhasil diubah!');
                    }
                });
            });
            
            const storageNames = {
                'local': 'Local Storage',
                'session': 'Session Storage',
                'memory': 'Memory Storage'
            };
            
            statusElement.textContent = storageNames[storageType];
            
            // Count total records
            let totalRecords = 0;
            Object.values(students).forEach(classStudents => {
                totalRecords += classStudents.length;
            });
            
            countElement.textContent = totalRecords;
            
            // Update session time
            const sessionMinutes = Math.floor((Date.now() - sessionStartTime) / 60000);
            document.getElementById('sessionTime').textContent = sessionMinutes + ' menit';
        }

        // Modal Management
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
            
            document.getElementById('confirmButton').onclick = function() {
                onConfirm();
                closeModal();
            };
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
        }

        function showLoading() {
            document.getElementById('loadingModal').classList.remove('hidden');
            document.getElementById('loadingModal').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
            document.getElementById('loadingModal').classList.remove('flex');
        }

        function showSuccess(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.classList.remove('hidden');
            toast.classList.add('slide-in');
            
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('slide-in');
            }, 3000);
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000); // Update every minute
            
            loadData();
            renderStudentList();
            updateQuickStats();
            updateSystemInfo();
            
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(saveData, 30000);
            
            // Update session time every minute
            setInterval(updateSystemInfo, 60000);
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            saveData();
            clearInterval(autoSaveInterval);
        });

        // Handle visibility change (when tab becomes hidden/visible)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveData();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9653d3bbc7a440ef',t:'MTc1MzUzMjE3NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
